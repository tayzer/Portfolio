name: Deploy Blazor to GitHub Pages

on:
  push:
    branches:
      - master

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore & Publish
        run: |
          # Restore the solution to ensure all projects and packages resolve
          dotnet restore "Portfolio.sln"
          # Publish the web project - specify the project file because the repo contains multiple projects
          dotnet publish "MyPortfolio.csproj" -c Release -o publish

      - name: Prepare Pages artifact
        run: |
          mkdir -p artifact
          cp -a publish/wwwroot/. artifact/
          # Prevent GitHub Pages (Jekyll) from ignoring files that start with an underscore
          echo "" > artifact/.nojekyll
          if [ -n "${{ secrets.CUSTOM_DOMAIN }}" ]; then echo "${{ secrets.CUSTOM_DOMAIN }}" > artifact/CNAME; fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: artifact

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_publish
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
